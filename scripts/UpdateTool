#!/bin/bash

# ============================================================
# R6 No Recoil Downloader
# ============================================================

echo -e "\033]0;R6 No Recoil Downloader\007"
echo -e "\033[1;37m"

echo "============================================================"
echo "    R6 NO RECOIL - LATEST DEVELOPMENT BUILD DOWNLOADER"
echo "============================================================"
echo
echo "This script will:"
echo "  - Download the latest R6 No Recoil build from GitHub."
echo "  - Extract it into one clean folder."
echo "  - Preserve the 'assets' folder."
echo "  - Replace WeaponData.json automatically."
echo
echo "Press CTRL+C to cancel at any time."
echo "------------------------------------------------------------"
echo

# Variables
url="https://nightly.link/Harry-Hopkinson/R6-No-Recoil/workflows/CI/main/R6NoRecoil.zip"
zipFile="R6NoRecoil.zip"
outputFolder="R6NoRecoil"
weaponData="WeaponData.json"

# Step 1: Check for curl and unzip
if ! command -v curl &> /dev/null; then
    echo "[ERROR] curl not found! Please install curl to run this script."
    exit 1
fi

if ! command -v unzip &> /dev/null; then
    echo "[ERROR] unzip not found! Please install unzip to run this script."
    exit 1
fi

echo "[INFO] curl and unzip detected."

echo "------------------------------------------------------------"
echo "[STEP 1/4] Downloading latest build..."
echo "URL: $url"
echo

# Step 2: Download ZIP
echo "[INFO] Starting download..."
if ! curl -L -o "$zipFile" "$url"; then
    echo "[ERROR] Failed to download ZIP file. Check your connection or URL."
    exit 1
fi
echo "[INFO] Download completed successfully."

echo "------------------------------------------------------------"
echo "[STEP 2/4] Extracting ZIP..."

# Step 3: Extract ZIP
if [ -d "$outputFolder" ]; then
    echo "[INFO] Removing old $outputFolder folder..."
    rm -rf "$outputFolder"
fi

if ! unzip -q "$zipFile" -d "$outputFolder"; then
    echo "[ERROR] Extraction failed."
    exit 1
fi
echo "[INFO] Extraction complete."

# Check if extraction was successful
if [ ! -d "$outputFolder" ]; then
    echo "[ERROR] Extraction failed â€” output folder missing."
    exit 1
fi

echo "------------------------------------------------------------"
echo "[STEP 3/4] Replacing WeaponData.json..."

# Step 4: Replace WeaponData.json
if [ -f "$weaponData" ]; then
    echo "[INFO] Found local WeaponData.json, copying to new folder..."
    cp -f "$weaponData" "$outputFolder/$weaponData"
    if [ -f "$outputFolder/$weaponData" ]; then
        echo "[SUCCESS] WeaponData.json replaced successfully."
    else
        echo "[WARNING] Failed to copy WeaponData.json to new folder."
    fi
else
    echo "[WARNING] No local WeaponData.json found in script directory."
fi

echo "------------------------------------------------------------"
echo "[STEP 4/4] Cleaning up..."

# Step 5: Clean up the temporary ZIP file
if [ -f "$zipFile" ]; then
    rm "$zipFile"
    echo "[INFO] Removed temporary ZIP file."
fi

echo
echo "All files extracted and WeaponData.json updated successfully!"
echo "Location: $(pwd)/$outputFolder"
echo "------------------------------------------------------------"
echo

# Prompt to open the folder
read -p "Would you like to open the folder now? (Y/N): " openfolder
if [[ "$openfolder" =~ ^[Yy]$ ]]; then
    open "$outputFolder"
fi

echo "------------------------------------------------------------"
echo "Script completed successfully. Thank you for using the R6 No Recoil Downloader!"
echo "------------------------------------------------------------"
